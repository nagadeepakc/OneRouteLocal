<!DOCTYPE html>
<html lang="en">
<head>
  <title>Worker Dashboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/fav_icon.png') }}">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="../static/css/worker_dashboard.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="//media.twiliocdn.com/taskrouter/js/v1.6/taskrouter.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
  <script language="JavaScript" type="text/javascript" src="//code.jquery.com/jquery-1.12.3.js"></script>
  <script language="JavaScript" type="text/javascript" src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
</head>

<body>
<div class = "row">
  <div class="container">
    <h1>Welcome, <span id="welcome_name"></span>!</h1><br><br>

    <h2>Tasks waiting</h2>

    <table id="tasks" class="display" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Tasks</th>
                </tr>
            </thead>

            <tbody>
                <tr>
                    <td>Task 1</td>
                </tr>
                <tr>
                    <td>Task 2</td>
                </tr>
                <tr>
                    <td>Task 3</td>
                </tr>
            </tbody>
    </table>

    
    <div class = "col-md-6">
      <h2 class="jqValue">Your current worker state: Idle</h2><br>
      <button id="active_btn" padding="2cm" type="button" class="btn btn-primary">Active</button>
      <button id="busy_btn" type="button" class="btn btn-primary">Busy</button><br>
      <button id="idle_btn" type="button" class="btn btn-primary">Idle</button>
      <button id="reserved_btn" type="button" class="btn btn-primary">Reserved</button><br><br>
      <button id="populate_tasks" type="button" class="btn btn-primary">Populate Tasks</button>
    </div>

  </div>
</div>


<script>
  // Initialize data table and order by Task ID
  $(document).ready(function() {
      $('#tasks').DataTable( {
              "paging": false,
         } );
  } );


  var account_sid = "ACc9111e5c0efc0644b4e754bf2183c1c2"
  var auth_token  = "86f3177a99d46d4cb6237b106be7bd9c"
  var workspace_sid = "WSa521ebd8b208fe727465ceb9c92bfc52"
  var worker_sid = get("worker_sid")
  var worker_name = get("worker_name")
  var activities_hash = {}

  activities_hash['Idle'] = {activitySid:"WA4a5d6980400c3748cc46d1e22493672c"}
  activities_hash['Busy'] = {activitySid:"WAac64dc68111c82fcaf8b78ec815afde8"}
  activities_hash['Reserved'] = {activitySid:"WA736c2c738b74abb7783e56de6c81ca2f"}
  activities_hash['Offline'] = {activitySid:"WA78c2554801eddb4b8c19aa0fb6279364"}

  if(history.replaceState) history.replaceState({}, "", "/worker_dashboard.html");
  document.getElementById('welcome_name').innerHTML = worker_name;





  function get_worker_tasks(task_queue_sid) {
    httpGetAsync("https://one-route.herokuapp.com/get_worker_tasks?worker_sid=" + task_queue_sid, tasks_callback);
  }

  function tasks_callback(responseText) {
    console.log("Made it to the tasks_callback...");
    var responseData = JSON.parse(responseText);
    var task_list = responseData["TaskList"];

    if (task_queue_list.length > 0 && task_queue_list.length > 0) {
      populate_task_list(task_list);
    }
  }

  function httpGetAsync(theUrl, callback)
  {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() { 
          if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
              callback(xmlHttp.responseText);
      }
      xmlHttp.open("GET", theUrl, true); // true for asynchronous 
      xmlHttp.send(null);
  }



  function populate_task_list(task_list) {
    for (task in task_list) {
      var populate_cards = document.getElementById("tasks");
      var task_list = []

      for(var i = 0; i < task_list.length; ++i) {
        var div_row = document.createElement("tr");
        div_row.className = "task_item";

        var p_details = document.createElement("td");
        p_details.text = task_list[i];

        div_row.appendChild(p_details);
        populate_cards.appendChild(div_row);
      }
    }
  }




  function get(name){
     if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
        return decodeURIComponent(name[1]);
  }


  var $jqValue = $('.jqValue');

  $('#active_btn').click(function () {
    $jqValue.text('Your current worker state:  Active');
    taskrouter_worker.updateActivity(activities_hash['Idle'].activitySid)
  });

  $('#busy_btn').click(function () {
    $jqValue.text('Your current worker state:  Busy');

  });

  $('#idle_btn').click(function () {
    $jqValue.text('Your current worker state:  Idle');
    taskrouter_worker.update(activities_hash['Idle'].activitySid)
  });

  $('#reserved_btn').click(function () {
    $jqValue.text('Your current worker state:  Reserved');
  });

  $('#populate_tasks').click(function () {
    $('#populate_tasks').value = "Getting tasks..."
    get_worker_tasks(worker_sid);
  });

</script>

</body>
</html>
